name: Build and publish plots

on:
  schedule:
    # NBM cycles: 00Z, 06Z, 12Z, 18Z. Early (~+75m) and late (~+165m).
    - cron: "15 1 * * *"   # 00Z early
    - cron: "45 2 * * *"   # 00Z late
    - cron: "15 7 * * *"   # 06Z early
    - cron: "45 8 * * *"   # 06Z late
    - cron: "15 13 * * *"  # 12Z early
    - cron: "45 14 * * *"  # 12Z late
    - cron: "15 19 * * *"  # 18Z early
    - cron: "45 20 * * *"  # 18Z late
  workflow_dispatch: {}

concurrency:
  group: build-plots
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system deps (GeoPandas/Shapely/GDAL + jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y gdal-bin libgdal-dev libspatialindex-dev jq

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', 'WatershedForecast.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python packages
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install geopandas shapely xarray matplotlib pandas requests netCDF4 rtree

      # ---- Probe NOMADS for newest NBM 1-hr blend URL ----
      - name: Probe latest forecast URL (skip heavy build if unchanged)
        id: probe
        shell: bash
        run: |
          set -euo pipefail
          python .github/scripts/probe.py
          echo "Probe output:"
          cat /tmp/probe.json
          latest_url=$(jq -r '.latest_url' /tmp/probe.json)
          has_new=$(jq -r '.has_new' /tmp/probe.json)
          echo "latest_url=$latest_url" >> "$GITHUB_OUTPUT"
          echo "has_new=$has_new" >> "$GITHUB_OUTPUT"
          echo "Latest URL: $latest_url"
          echo "Has new:    $has_new"

      - name: Build plots (offline, using cached basin geojsons)
        if: steps.probe.outputs.has_new == 'true'
        run: |
          python WatershedForecast.py --all --offline

      - name: Update last_forecast_url marker
        if: steps.probe.outputs.has_new == 'true'
        run: |
          echo "${{ steps.probe.outputs.latest_url }}" > .github/last_forecast_url.txt

      - name: Commit updated docs assets, index.html, and marker
        if: steps.probe.outputs.has_new == 'true'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/assets docs/index.html .github/last_forecast_url.txt || true
          if ! git diff --cached --quiet; then
            git commit -m "Auto-update plots and index for ${{ steps.probe.outputs.latest_url }}"
            git push
          else
            echo "No changes to commit."
          fi

